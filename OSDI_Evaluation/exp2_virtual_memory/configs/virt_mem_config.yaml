# Virtual Memory Ring Buffer Experiment Configuration

experiment:
  name: "virtual_memory_ring_buffer"
  description: "Experiment 2: Skip-End Ring Buffer for weight streaming"
  
  # Ring buffer configuration
  ring_buffer:
    enabled: true
    capacity_gb: 48  # Circular buffer size
    prefetch_workers: 1  # Number of prefetch threads
  
  # Model configuration
  model:
    # For Llama-70B full run
    model_id: "meta-llama/Llama-2-70b-hf"
    dtype: "float16"  # FP16 for bandwidth savings
    device: "cuda:0"
  
  # Inference configuration
  inference:
    batch_size: 1  # Single inference
    max_seq_len: 2048
    prompt_length: 512  # Initial prompt tokens
    generation_length: 50  # Tokens to generate
    temperature: 0.7
    top_p: 0.9
  
  # Measurement configuration
  measurement:
    runs: 5  # Number of inference runs
    warmup_runs: 2  # Warmup iterations (not measured)
    gc_between_runs: true  # Run garbage collection between runs
    disable_gc_during_run: true  # Disable GC during timed measurements

# Baseline configurations (for comparison)
baselines:
  vllm:
    enabled: false  # May OOM
    device_map: "sequential"
    max_num_seqs: 1
  
  hf_accelerate:
    enabled: false  # Slow but working
    device_map: "auto"
    offload_folder: "/tmp/hf_offload"
  
  ring_buffer_no_prefetch:
    enabled: false  # Ablation study
    use_async_prefetch: false
  
  ring_buffer_async_prefetch:
    enabled: true  # Full Djinn implementation
    use_async_prefetch: true

# Performance tuning
tuning:
  # Host memory pinning
  pin_weights: true
  pin_memory_gb: 20  # Pre-allocate pinned memory pool
  
  # CUDA optimization
  cuda_graphs: false  # Disable for weight streaming
  torch_compile: false  # Disable for flexibility
  cudnn_benchmark: true  # Enable autotuner
  
  # Stream priorities
  prefetch_stream_priority: -1  # High priority
  compute_stream_priority: 0  # Normal priority

# Evaluation environment (OSDI checklist requirements)
environment:
  os_swap: "disabled"  # Must run: swapoff -a
  ulimit_memlock: "unlimited"  # Must run: ulimit -l unlimited
  numa_bind: false  # Optional: numactl --cpunodebind=X
  
  # GPU configuration
  gpu_index: 0
  max_gpu_memory_gb: 60  # Strict limit for this experiment
  os_reserve_gb: 2
  safety_margin_gb: 1

# Logging and output
logging:
  level: "INFO"
  verbose: true
  log_file: "/tmp/djinn_virt_mem_exp.log"

output:
  # Results saved to this directory
  results_dir: "OSDI_Evaluation/exp2_virtual_memory/results"
  
  # Metrics to collect
  metrics:
    - "effective_bandwidth_gbps"
    - "latency_ms"
    - "peak_vram_mb"
    - "logit_norm_diff"
    - "prefetch_success_rate"
    - "event_sync_latency_us"

